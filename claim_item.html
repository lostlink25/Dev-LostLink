<!DOCTYPE HTML>
     <html>
         <head>
             <title>LostLink - Claim Item</title>
             <meta charset="utf-8" />
             <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes" />
             <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' 'unsafe-eval' https://accounts.google.com https://www.gstatic.com https://apis.google.com; object-src 'none'; base-uri 'self';" />
             <link rel="stylesheet" href="assets/css/main.css" />
             <noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
             <style>
                 .claim-section {
                     padding: 20px;
                     max-width: 600px;
                     margin: 0 auto;
                 }
                 .form-group {
                     margin-bottom: 15px;
                 }
                 .form-group label {
                     display: block;
                     margin-bottom: 5px;
                     font-weight: bold;
                 }
                 .form-group input, .form-group select {
                     width: 100%;
                     padding: 8px;
                     border: 1px solid #ccc;
                     border-radius: 4px;
                     box-sizing: border-box;
                 }
                 .matches-container {
                     margin-top: 10px;
                     padding: 10px;
                     border: 1px solid #ccc;
                     border-radius: 4px;
                     max-height: 150px;
                     overflow-y: auto;
                 }
                 .match-item {
                     padding: 5px;
                     border-bottom: 1px solid #eee;
                 }
                 .match-item:last-child {
                     border-bottom: none;
                 }
                 .submit-button {
                     display: inline-block;
                     padding: 10px 20px;
                     background-color: #df7366;
                     color: white;
                     border: none;
                     border-radius: 4px;
                     cursor: pointer;
                     font-size: 1em;
                 }
                 .submit-button:hover {
                     background-color: #ef8376;
                 }
                 .error, .success {
                     display: none;
                     text-align: center;
                     margin-top: 20px;
                     font-size: 0.9em;
                 }
                 .error {
                     color: red;
                 }
                 .success {
                     color: green;
                 }
                 @media screen and (max-width: 768px) {
                     .claim-section {
                         padding: 10px;
                     }
                     .form-group input, .form-group select {
                         font-size: 0.9em;
                     }
                     .submit-button {
                         width: 100%;
                         padding: 12px;
                     }
                 }
             </style>
             <script src="https://accounts.google.com/gsi/client" async defer></script>
             <script src="https://apis.google.com/js/api.js"></script>
         </head>
         <body class="is-preload">
             <div id="page-wrapper">
                 <!-- Header -->
                 <div id="header">
                     <!-- Nav -->
                     <nav id="nav">
                         <ul>
                             <li><a href="index.html">Home</a></li>
                             <li><a href="About_Us.html">About Us</a></li>
                             <li><a href="Report_Lost_Items.html">Report Lost Items</a></li>
                             <li><a href="track_your_item.html">Track Items</a></li>
                             <li><a href="claim_item.html">Claim Items</a></li>
                             <li><a href="claim_submission.html">Claim Submissions</a></li>
                             <li><a href="contact_support.html">Contact Us</a></li>
                         </ul>
                     </nav>
                 </div>

                 <!-- Main -->
                 <div class="wrapper style2">
                     <article id="main" class="container special">
                         <header>
                             <h2>Claim an Item</h2>
                             <p>Staff can claim a found item by providing the Tracking ID and claimant details, with potential matches suggested.</p>
                         </header>
                         <section class="claim-section">
                             <form id="claimForm">
                                 <div class="form-group">
                                     <label for="trackingId">Found Tracking ID</label>
                                     <input type="text" id="trackingId" name="trackingId" placeholder="Enter Tracking ID (e.g., FOUND-0001-ABC)" required />
                                 </div>
                                 <div class="form-group">
                                     <label for="lostTrackingId">Select Matching Lost Tracking ID (if any)</label>
                                     <select id="lostTrackingId" name="lostTrackingId">
                                         <option value="">No Match</option>
                                     </select>
                                     <div class="matches-container" id="matchesContainer"></div>
                                 </div>
                                 <div class="form-group">
                                     <label for="claimantDetails">Claimant Details</label>
                                     <input type="text" id="claimantDetails" name="claimantDetails" placeholder="Enter claimant name or email" required />
                                 </div>
                                 <button type="submit" class="submit-button">Claim Item</button>
                             </form>
                             <p class="error" id="claimError"></p>
                             <p class="success" id="claimSuccess"></p>
                             <p><a href="contact_support.html">Need help? Contact support.</a></p>
                         </section>
                     </article>
                 </div>

                 <!-- Footer -->
                 <div id="footer">
                     <div class="container">
                         <div class="row">
                             <section class="contact">
                                 <header>
                                     <h3>Have Questions?</h3>
                                 </header>
                                 <p>Our support team is here to assist you with tracking or recovering your lost items.</p>
                                 <ul class="icons">
                                     <li><a href="#" class="icon brands fa-x-twitter"><span class="label">X</span></a></li>
                                     <li><a href="https://www.facebook.com" class="icon brands fa-facebook-f"><span class="label">Facebook</span></a></li>
                                     <li><a href="#" class="icon brands fa-instagram"><span class="label">Instagram</span></a></li>
                                     <li><a href="#" class="icon brands fa-pinterest"><span class="label">Pinterest</span></a></li>
                                     <li><a href="#" class="icon brands fa-dribbble"><span class="label">Dribbble</span></a></li>
                                     <li><a href="#" class="icon brands fa-linkedin-in"><span class="label">Linkedin</span></a></li>
                                 </ul>
                             </section>
                             <div class="copyright">
                                 <ul class="menu">
                                     <li>Â© LostLink. All rights reserved.</li>
                                     <li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
                                 </ul>
                             </div>
                         </div>
                     </div>
                 </div>
             </div>

             <!-- Scripts -->
             <script src="assets/js/jquery.min.js"></script>
             <script src="assets/js/jquery.dropotron.min.js"></script>
             <script src="assets/js/jquery.scrolly.min.js"></script>
             <script src="assets/js/jquery.scrollex.min.js"></script>
             <script src="assets/js/browser.min.js"></script>
             <script src="assets/js/breakpoints.min.js"></script>
             <script src="assets/js/util.js"></script>
             <script src="assets/js/main.js"></script>
             <script>
                 console.log('Script loaded at:', new Date().toISOString());
                 try {
                     console.log('Checking for jQuery');
                     if (typeof jQuery === 'undefined') {
                         console.error('jQuery not loaded');
                         alert('Error: jQuery not loaded. Please contact support.');
                         throw new Error('jQuery not loaded');
                     }
                     console.log('jQuery loaded:', jQuery.fn.jquery);

                     const CLIENT_ID = '321609158255-091oanamuil8009na1t2ajdk6190p5d0.apps.googleusercontent.com';
                     const FOUND_SPREADSHEET_ID = '1Ua03tbd9imSPsGRjuFi7FLN0YAXW9GSKMPBrrlHd8Wc';
                     const LOST_SPREADSHEET_ID = '1Ua03tbd9imSPsGRjuFi7FLN0YAXW9GSKMPBrrlHd8Wc';
                     const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

                     function initGapiClient() {
                         console.log('Initializing Google API client');
                         return new Promise((resolve, reject) => {
                             gapi.load('client', () => {
                                 gapi.client.init({
                                     discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
                                 }).then(() => {
                                     console.log('gapi client initialized');
                                     resolve();
                                 }).catch(error => {
                                     console.error('gapi client initialization error:', error);
                                     reject(error);
                                 });
                             });
                         });
                     }

                     function getAccessToken() {
                         console.log('Initiating Google Sign-In');
                         return new Promise((resolve, reject) => {
                             try {
                                 const client = google.accounts.oauth2.initTokenClient({
                                     client_id: CLIENT_ID,
                                     scope: SCOPES,
                                     prompt: 'select_account',
                                     callback: (response) => {
                                         console.log('OAuth callback received:', JSON.stringify(response));
                                         if (response.error) {
                                             console.error('OAuth error:', response.error, response.error_description);
                                             if (response.error === 'access_denied') {
                                                 reject(new Error('Access denied: Please use an authorized staff account.'));
                                             } else {
                                                 reject(new Error(`OAuth error: ${response.error} - ${response.error_description || 'No description'}`));
                                             }
                                         } else if (!response.access_token) {
                                             console.error('No access token in response');
                                             reject(new Error('No access token received from Google Sign-In.'));
                                         } else {
                                             console.log('Access token received:', response.access_token.substring(0, 20) + '...');
                                             resolve(response.access_token);
                                         }
                                     }
                                 });
                                 console.log('Requesting access token');
                                 client.requestAccessToken();
                             } catch (error) {
                                 console.error('Error initializing Google Sign-In:', error);
                                 reject(new Error(`Failed to initialize Google Sign-In: ${error.message}`));
                             }
                         });
                     }

                     function computeLevenshteinDistance(str1, str2) {
                         const m = str1.length, n = str2.length;
                         const dp = Array(m + 1).fill().map(() => Array(n + 1).fill(0));
                         for (let i = 0; i <= m; i++) dp[i][0] = i;
                         for (let j = 0; j <= n; j++) dp[0][j] = j;
                         for (let i = 1; i <= m; i++) {
                             for (let j = 1; j <= n; j++) {
                                 dp[i][j] = Math.min(
                                     dp[i - 1][j] + 1,
                                     dp[i][j - 1] + 1,
                                     dp[i - 1][j - 1] + (str1[i - 1] === str2[j - 1] ? 0 : 1)
                                 );
                             }
                         }
                         return dp[m][n];
                     }

                     function computeSimilarity(str1, str2) {
                         const maxLen = Math.max(str1.length, str2.length);
                         if (maxLen === 0) return 100;
                         const distance = computeLevenshteinDistance(str1.toLowerCase(), str2.toLowerCase());
                         return ((maxLen - distance) / maxLen) * 100;
                     }

                     async function findMatches(trackingId) {
                         try {
                             await initGapiClient();
                             const accessToken = await getAccessToken();
                             gapi.client.setToken({ access_token: accessToken });

                             console.log('Fetching found item:', trackingId);
                             const foundResponse = await gapi.client.sheets.spreadsheets.values.get({
                                 spreadsheetId: FOUND_SPREADSHEET_ID,
                                 range: 'FoundItems!A:J'
                             });
                             const foundRows = foundResponse.result.values || [];
                             let foundItem = null;
                             for (let i = 1; i < foundRows.length; i++) {
                                 if (foundRows[i][1] === trackingId && foundRows[i][7] === 'Available') {
                                     foundItem = foundRows[i];
                                     break;
                                 }
                             }
                             if (!foundItem) {
                                 throw new Error('TrackingID not found or item is not available.');
                             }

                             console.log('Fetching lost items');
                             const lostResponse = await gapi.client.sheets.spreadsheets.values.get({
                                 spreadsheetId: LOST_SPREADSHEET_ID,
                                 range: 'LostItems!A2:I'
                             });
                             const lostItems = lostResponse.result.values || [];

                             const matches = [];
                             const foundItemType = foundItem[2];
                             const foundAirport = foundItem[3];
                             const foundDescription = foundItem[4];
                             lostItems.forEach(lost => {
                                 const lostTrackingId = lost[8];
                                 const lostItemType = lost[5];
                                 const lostAirport = lost[4];
                                 const lostDescription = lost[6];
                                 if (lostItemType === foundItemType && lostAirport === foundAirport) {
                                     const similarity = computeSimilarity(lostDescription, foundDescription);
                                     const confidence = 80 + (similarity / 5);
                                     if (confidence >= 70) {
                                         matches.push({
                                             lostTrackingId,
                                             similarity: similarity.toFixed(2),
                                             confidence: confidence.toFixed(2)
                                         });
                                     }
                                 }
                             });

                             return matches;
                         } catch (error) {
                             console.error('Error finding matches:', error);
                             throw error;
                         }
                     }

                     async function claimItem(trackingId, lostTrackingId, claimantDetails) {
                         try {
                             await initGapiClient();
                             const accessToken = await getAccessToken();
                             gapi.client.setToken({ access_token: accessToken });

                             console.log('Fetching found items to locate TrackingID:', trackingId);
                             const response = await gapi.client.sheets.spreadsheets.values.get({
                                 spreadsheetId: FOUND_SPREADSHEET_ID,
                                 range: 'FoundItems!A:J'
                             });

                             const rows = response.result.values || [];
                             if (rows.length <= 1) {
                                 throw new Error('No items found in the sheet.');
                             }

                             let rowIndex = -1;
                             for (let i = 1; i < rows.length; i++) {
                                 if (rows[i][1] === trackingId && rows[i][7] === 'Available') {
                                     rowIndex = i + 1;
                                     break;
                                 }
                             }

                             if (rowIndex === -1) {
                                 throw new Error('TrackingID not found or item is not available.');
                             }

                             console.log(`Updating Status to Claimed for TrackingID: ${trackingId} at row ${rowIndex}`);
                             const updateResponse = await gapi.client.sheets.spreadsheets.values.update({
                                 spreadsheetId: FOUND_SPREADSHEET_ID,
                                 range: `FoundItems!H${rowIndex}`,
                                 valueInputOption: 'USER_ENTERED',
                                 resource: {
                                     values: [['Claimed']]
                                 }
                             });

                             console.log('Update API response status:', updateResponse.status);
                             if (updateResponse.status !== 200) {
                                 throw new Error(`HTTP error! Status: ${updateResponse.status}`);
                             }

                             if (lostTrackingId) {
                                 console.log('Saving match to ClaimItems');
                                 await gapi.client.sheets.spreadsheets.values.append({
                                     spreadsheetId: FOUND_SPREADSHEET_ID,
                                     range: 'ClaimItems!A:I',
                                     valueInputOption: 'USER_ENTERED',
                                     resource: {
                                         values: [[
                                             lostTrackingId,
                                             trackingId,
                                             rows[rowIndex - 1][2], // ItemType
                                             rows[rowIndex - 1][3], // Airport
                                             'N/A', // DescriptionSimilarity (simplified)
                                             'N/A', // MatchConfidence (simplified)
                                             'Confirmed',
                                             claimantDetails,
                                             new Date().toISOString()
                                         ]]
                                     }
                                 });
                             }

                             $('#claimSuccess').text(`Item ${trackingId} has been claimed successfully for ${claimantDetails}${lostTrackingId ? ' with match ' + lostTrackingId : ''}.`).css('display', 'block');
                             $('#claimError').hide();
                             $('#claimForm').trigger('reset');
                             $('#lostTrackingId').empty().append('<option value="">No Match</option>');
                             $('#matchesContainer').empty();
                         } catch (error) {
                             console.error('Claim error:', error.message || error);
                             $('#claimError').text('Failed to claim item: ' + (error.message || 'Unknown error')).css('display', 'block');
                             $('#claimSuccess').hide();
                         }
                     }

                     document.addEventListener('DOMContentLoaded', () => {
                         console.log('DOM loaded, initializing form');
                         $('#claimError').hide();
                         $('#claimSuccess').hide();

                         $('#trackingId').on('input', async function() {
                             const trackingId = $(this).val().trim();
                             const matchesContainer = $('#matchesContainer');
                             const lostTrackingIdSelect = $('#lostTrackingId');
                             matchesContainer.empty();
                             lostTrackingIdSelect.empty().append('<option value="">No Match</option>');

                             if (trackingId.length >= 5) {
                                 try {
                                     const matches = await findMatches(trackingId);
                                     if (matches.length > 0) {
                                         matches.forEach(match => {
                                             const matchDiv = `<div class="match-item">Lost TrackingID: ${match.lostTrackingId} (Confidence: ${match.confidence}%)</div>`;
                                             matchesContainer.append(matchDiv);
                                             lostTrackingIdSelect.append(`<option value="${match.lostTrackingId}">${match.lostTrackingId} (${match.confidence}%)</option>`);
                                         });
                                     } else {
                                         matchesContainer.text('No potential matches found.');
                                     }
                                 } catch (error) {
                                     matchesContainer.text('Error finding matches: ' + (error.message || 'Unknown error'));
                                 }
                             }
                         });

                         $('#claimForm').on('submit', function(e) {
                             e.preventDefault();
                             const trackingId = $('#trackingId').val().trim();
                             const lostTrackingId = $('#lostTrackingId').val();
                             const claimantDetails = $('#claimantDetails').val().trim();

                             if (trackingId.length < 5 || claimantDetails.length < 2) {
                                 $('#claimError').text('TrackingID must be at least 5 characters and Claimant Details at least 2 characters.').css('display', 'block');
                                 $('#claimSuccess').hide();
                                 return;
                             }

                             claimItem(trackingId, lostTrackingId || null, claimantDetails);
                         });
                     });
                 } catch (error) {
                     console.error('Script initialization error:', error.message);
                     $('#claimError').text('Initialization failed: ' + error.message).css('display', 'block');
                 }
             </script>
         </body>
     </html>